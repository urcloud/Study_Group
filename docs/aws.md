## 배포
IP나 도메인과 같이 고유의 주소를 부여받고, 다른 컴퓨터에서 그 주소로 접속할 수 있게 되는 것을 배포하고 함

## EC2
* 서버를 배포하기 위해서는 컴퓨터가 필요함
* 이때, 내 컴퓨터로 서버를 배포하면 24시간 컴퓨터를 켜놔야 하고, 인터넷을 통해 내 컴퓨터에 접근할 수 있게 만들다보니 보안적으로도 위험할 수 있음
* 위와 같은 불편함 때문에 AWS EC2라는 컴퓨터를 빌려서 사용하는 것
* AWS EC2는 여러 부가기능들(로깅, 오토스케일링, 로드밸런싱 등)을 가지고 있음
* AWS EC2는 주로 백엔드 서버를 배포할 때. 프론트엔드는 vercel, netlify, AWS S3를 사용해서 주로 배포함

## 배포 과정
1. Region 선택
    - 인프라를 지리적으로 나누어 배포한 각각의 데이터 센터를 의미
    - EC2가 컴퓨터를 빌려서 원격으로 접속해 사용하는 서비스인데, 해당 컴퓨터는 전세계적으로 분포가 되어 있음
    - 이때 컴퓨터가 위치한 위치를 AWS에서는 Region이라고 함
    - 각 Region은 고유의 이름을 가지고 있음
    - 애플리케이션의 주된 이융자들의 위치와 지리적으로 가까운 Region을 선택하는 것이 유리
    - 사람들이 애플리케이션을 사용할 때는 네트워크를 통해 통신하는데 사용자의 위치와 애플리케이션을 실행시키고 있는 컴퓨터와 위치가 멀면 멀수록 속도가 느리기 때문
    - 웹페이지를 받거나 데이터를 받는 등의 통신은 전기선을 통해 신호를 받고 신호에 맞는 전기를 통해 데이터를 송수신하는데, 전기도 거리가 멀수록 시간이 오래걸리기 때문에 통신이 느려짐
    - Region마다 EC2가 따로따로 관리가 되고 있어 A Region에서 EC2를 생성하고 B Region에 들어가면 EC2는 없음

2. EC2 빌리기: 인스턴스 시작 누르고 이름 설정
   - 이름 및 태그는 EC2의 이름을 설정하는 곳으로, 어떤 역할을 하는지 알아볼 수 있도록 작성하는 것이 좋음
   - 여기서는 study-server로 설정

3. 애플리케이션 및 OS 이미지 설정
   - Amazon Linux
     - AWS 최적화: CloudWatch, SSM 등 AWS 서비스와 통합이 쉬움 
     - 경량화 & 성능 최적화: EC2 환경에서 빠르게 동작
     - 보안 패치: AWS에서 지속적으로 업데이트 제공 
     - 무료 지원: 추가 라이선스 비용 없음 
     - Long-term support: Amazon Linux 2는 LTS 제공
     - 패키지 지원이 Ubuntu/ Debian보다 적음
     - 커뮤니티 자료/문서가 Ubuntu보다 상대적으로 적음
     - macOS, Windows용 앱 개발 환경에는 부적합
     - 따라서 AWS 환경 최적화 백엔드 서버, 비용 효율적이고 안정적인 Linux 서버 필요 시 주로 사용
   - macOS
     - macOS 전용 개발 가능 (Xcode, iOS 앱 빌드)
     - Apple 생태계 개발 환경 구축 가능
     - 비용 매우 높음 (EC2 Mac 인스턴스)
     - 서버/웹 서비스 운영용으로 비효율적 
     - EC2 Mac 인스턴스는 선택 가능한 리전 제한 있음 
     - 초기 설정 복잡 
     - iOS/macOS 앱 빌드, CI/CD용으로 주로 사용해 일반 웹 서비스/백엔드 배포에는 비추천
   - Ubuntu
     - 패키지 풍부: apt 패키지로 대부분 소프트웨어 설치 가능 
     - 커뮤니티 & 자료 풍부: 문제 해결 자료, 튜토리얼 많음 
     - LTS(Long-term support): 5년 지원 (Ubuntu 22.04 LTS 등)
     - 개발 편의성: 다양한 오픈소스 프로젝트와 호환성 좋음
     - Amazon Linux보다 AWS 최적화는 덜 됨 (하지만 거의 무시 가능)
     - 서버용으로 설치 시 필요 없는 패키지 많음 
     - 업데이트 관리 주의 필요 (보안 패치 누락 시 위험)
     - Linux 친숙한 개발 환경이며, 다양한 오픈소스와 호환성이 중요한 프로젝트, Spring Boot + MySQL 배포 등 대부분의 웹 서비스에서 주로 사용
   - Windows
     - Windows 기반 소프트웨어 호환: IIS, .NET, MSSQL 등
     - GUI 지원: 윈도우 GUI 환경 사용 가능
     - Active Directory, 그룹 정책 등 엔터프라이즈 환경 호환
     - 비용 높음: 라이선스 포함 비용 발생
     - Linux 대비 메모리/CPU 오버헤드 큼
     - 서버 관리 난이도 높음 (패치 관리 등)
     - CLI 자동화 편의성 떨어짐
     - .NET, MSSQL 기반 서비스나 GUI 환경 필요 시, Windows 전용 라이브러리 사용하는 프로젝트에서 주로 사용
   - 따라서 이 프로젝트에서는 Ubuntu 사용함, 버전은 그대로 최신 버전
   
4. 인스턴스 유형
    - 인스턴스는 AWS EC2에서 빌리는 컴퓨터 1대를 의미함
    - 인스턴스 유형은 컴퓨터 사양을 의미함
    - 컴퓨터 사양이 좋으면 좋을수록 많은 수의 요청을 처리할 수 있고, 무거운 서버나 프로그램을 돌릴 수 있음
    - t3.micro
      - AWS의 범용 버스트 가능한 인스턴스
      - 기본 CPU 성능이 낮지만 필요할 때 CPU 성능을 일시적으로 올릴 수 있음
      - vCPU는 2개, 메모리는 1GB인 저사양 인스턴스
      - 소규모 웹 서버, 테스트 서버, 개발 환경 등 CPU와 메모리 요구가 낮은 서비스에 적합함
    - t3.small
      - 마찬가지로 범용 버스트 가능한 인스턴스
      - 메모리 2GB를 제공, vCPU는 2개
      - 기본 CPU 성능은 낮지만 버스트 가능한 구조를 갖추고 있어 일시적인 CPU 부하에 대응할 수 있음 
      - 소규모 DB 서버나 트래픽이 조금 더 많은 웹 서비스에 적합함
    - c7i-flex.large
      - AWS의 컴퓨팅 최적화형 인스턴스
      - CPU 성능이 강점이며 메모리 대비 CPU 비율이 높음
      - Flexible 옵션을 사용하면 vCPU와 메모리를 유연하게 선택할 수 있음
      - 연산 집약적인 작업, 대규모 데이터 처리, 고성능 계산 작업에 적합함
      - 작은 웹 서비스용으로는 과도한 사양
    - m7i-flex.large
      - 범용 인스턴스의 최신형
      - CPU와 메모리의 균형이 잘 맞아 다양한 워크로드에 적합함
      - Flexible 옵션을 통해 vCPU와 메모리를 유연하게 설정할 수 있음
      - 웹 서버, 데이터베이스 서버, 엔터프라이즈 애플리케이션 등 범용 용도로 활용 가능
      - 소규모 테스트 서버에는 과도한 사양
    - 이 프로젝트에서는 t3.micro 인스턴스 사용

5. 키 페어 로그인
    - EC2 컴퓨터에 접근할 때 사용하는 비밀번호로, 열쇠(Key, 키)의 역할을 함
    - 빌린 컴퓨터에 아무나 접근하지 못하도록 막는 용도임
    - 키 페어 이름은 어떤 EC2에 접근하기 위한 키 페어였는지 알아볼 수 있게 지정하면 좋음
    - 여기서는 study-server-key-pair로 이름 설정
    - 키 페어를 생성하면 파일이 하나 다운되는데, 이 파일은 EC2에 접속하는 용도로 사용할 수 있음
    - 잃어버리면 안 되니 잘 보관해놔야함
    - 유출되면 다른 사람도 빌린 EC2에 접근이 가능해짐

6. 보안 그룹 설정
    - 보안 그룹은 AWS 클라우드에서의 네트워크 보안을 의미함
    - EC2 인스턴스를 집이라고 생각한다면, 보안 그룹은 집 바깥 쪽에 쳐져있는 울타리와 대문이라고 생각하면 됨
    - 집에 접근할 때 울타리의 대문에서 접근해도 되는 요청인지 보안 요원이 검사를 하는 것과 비슷함
    - 인터넷에서 일부 사용자가 EC2 인스턴스에 접근하려고 할 때 EC2 인스턴스 주위에 방화벽 역할을 할 보안 그룹을 만들고 보안 그룹에 규칙을 지정함
    - 보안규칙은 크게 두 가지
      - 인바운드 트래픽(즉, 외부에서 EC2 인스턴스로 보내는 트래픽)에서 어떤 트래픽만 허용할 지 설정할 수 있음
      - 아웃바운드 트래픽(즉, EC2 인스턴스에서 외부로 나가는 트래픽)에서 어떤 트래픽만 허용할 지 설정할 수 있음
    - IP는 네트워크 상에서의 특정 컴퓨터를 가리키는 주소
    - Port는 한 컴퓨터 내에서 실행되고 있는 특정 프로그램의 주소 (한 컴퓨터 내에서는 여러 프로그램이 실행되고 있음)
    - 포트 번호는 0 ~ 65,535번까지 사용할 수 있는데, 그 중 0 ~ 1023번까지의 포트 번호는 주요 통신을 위한 규약에 따라 이미 정해져 있음 (잘 알려진 포트, well-known port)
      - 22번 (SSH, Secure Shell Protocol) : 원격 접속을 위한 포트 번호, EC2 인스턴스에 연결할 때 22번 포트를 사용함
      - 80번 (HTTP) : HTTP로 통신을 할 때 사용
      - 443번 (HTTPS) : HTTPS로 통신을 할 때 사용
    - 여기서는 EC2 인스턴스 생성 때 보안 그룹 설정을
      - 보안 그룹 이름: study-server-security-group
      - 유형
        - ssh: 원격 접속하기 위한 경로
        - http
      - 포트 범위: 접근 포트는 22번 포트와 80번 포트 2가지
        - 22: EC2에 원격 접속할 때 사용하는 포트
        - 80: 백엔드 서버를 띄울 포트여서 서버에 요청이 들어와야 응답이 가능해짐

7. 스토리지 구성
    - 우리가 쓰고 있는 노트북이나 데스크톱 컴퓨터는 전부 하드디스크를 가지고 있음
    - 하드디스크: 컴퓨터에서 파일을 저장하는 공간
    - EBS(Elastic Block Storage): EC2에서 여러 파일들을 저장할 저장 공간, EC2 안에 부착되어 있는 일종의 하드디스크
    - EBS와 같은 저장 공간을 조금 더 포괄적인 용어로 스토리지(Storage), 볼륨(Volume)이라고 부름
    - 이 프로젝트에서는 gp3 이외에도 여러가지 종류의 스토리지가 있지만 가성비가 좋은 gp3를 선택
    - 용량은 30GiB 선택(프리 티어에서 30GiB까지 무료 제공)
    - 스토리지의 크기는 추후에 늘릴 수도 있으므로 처음 설정할 때 너무 큰 고민을 할 필요는 없음

8. 인스턴스 시작

9. SSH 키 파일 권한 설정
    - git bash 열고 chmod 400 "study-server-key-pair.pem" 입력
    - chmod 400으로 읽기 전용 권한을 소유자에게만 부여함
      - 4는 읽기 권한(Read), 0은 쓰기/실행 권한 없음 
      - 첫 번째 숫자는 소유자 권한 
      - 나머지 두 개는 그룹, 기타 사용자 권한 없음 
      - 즉, 소유자만 읽을 수 있고, 아무도 쓰거나 실행할 수 없음

10. EC2 접속
    - ssh -i "study-server-key-pair.pem" ubuntu@<EC2_PUBLIC_IP> 입력

11. Docker 설치
    - Docker로 배포하려면 Ubuntu에 Docker을 설치해야 함
    - usermod 후에 세션 재접속 필요
      - sudo apt update
      - sudo apt install -y docker.io docker-compose
      - sudo systemctl start docker
      - sudo systemctl enable docker
      - sudo usermod -aG docker $USER
    - $USER는 현재 로그인 세션의 사용자 이름을 뜻함
    - 여기서 로그인 유저는 ubuntu

12. EC2에 배포에 필요한 파일 올리기
    - 배포에는 docker-compose.yaml, Dockerfile, jar 파일이 필요함
    - Dockerfile로 이미지 빌드를 해서 컨테이너 안에는 이미 Spring Boot 애플리케이션이 jar 파일 형태로 존재하고 실행 준비가 되어 있음
    - docker-compose.yaml로 서비스 정의를 해 docker-compose.yaml에 있는 설정만으로 앱과 DB가 서로 통신 가능하고 컨테이너가 정상적으로 실행됨
    - 모든 Java 소스코드는 jar 안에 컴파일된 클래스와 리소스 형태로 들어감
    - 배포에 필요한 세 개의 파일을 하나의 폴더로 묶어서 올릴 수 있음
      - 여기서는 studygroupserver로 올림
      - scp -i "E:/university/campus_activity/CURT/grade4_semester2/study-server-key-pair2.pem" -r "C:/Users/epoin/OneDrive/문서/studygroupserver" ubuntu@3.34.190.226:~/
    - 서버에서 파일이 다 올라갔는지 확인 가능
      - cd studygroupserver
      - ls
    - Dockerfile  docker-compose.yaml  study_group-0.0.1-SNAPSHOT.jar 파일이 올라갔으면 이렇게 뜸

13. Docker 서버에서 실행
    - docker-compose up -d --build로 실행
    - docker ps로 실행 중인 컨테이너 확인 가능
    - docker-compose logs -f로 컨테이너의 로그 확인 가능

14. 배포 확인
    - 브라우저에서 http://<EC2 퍼블릭 IP>:8080 접속해서 확인
    - 이 프로젝트의 경우 http://3.34.190.226:8080에 접속해서 확인 가능